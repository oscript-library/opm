// Comprehensive test for developer dependencies functionality
// This test verifies the fix for issue where opm install -l --dev was not installing developer dependencies

#Использовать "/home/runner/work/opm/opm/src/core"
#Использовать "1testrunner"
#Использовать "asserts"

Процедура ТестДолжен_ФильтроватьЗависимостиПоФлагуРазработчика() Экспорт
    
    // Создаем тестовый манифест с обычными и dev зависимостями  
    Манифест = Новый ОписаниеПакета();
    Манифест.Имя("test-package")
        .Версия("1.0.0")
        .ВерсияСреды("1.9.2")
        .ЗависитОт("regular-dep", "1.0.0")
        .РазработкаЗависитОт("dev-dep", "1.0.0");
        
    // Создаем менеджер установки в локальном режиме
    МенеджерУстановки = Новый МенеджерУстановкиПакетов(РежимУстановкиПакетов.Локально);
    
    // Тест 1: Без флага dev - должна устанавливаться только обычная зависимость
    МенеджерУстановки.УстанавливатьЗависимостиРазработчика(Ложь);
    
    // Имитируем фильтрацию, которая происходит в РазрешитьЗависимостиПакета
    ВсеЗависимости = Манифест.Зависимости();
    Утверждения.ПроверитьРавенство(2, ВсеЗависимости.Количество(), "Всего должно быть 2 зависимости");
    
    // Фильтруем как в исправленном коде
    УстанавливатьЗависимостиРазработчика = Ложь;
    УровеньЗависимости = 0;
    
    ФильтрованныеЗависимости = Новый ТаблицаЗначений;
    Для Каждого Колонка Из ВсеЗависимости.Колонки Цикл
        ФильтрованныеЗависимости.Колонки.Добавить(Колонка.Имя, Колонка.ТипЗначения);
    КонецЦикла;
    
    Для Каждого Зависимость Из ВсеЗависимости Цикл
        Если Не Зависимость.ДляРазработки ИЛИ (УстанавливатьЗависимостиРазработчика И УровеньЗависимости = 0) Тогда
            ЗаполнитьЗначенияСвойств(ФильтрованныеЗависимости.Добавить(), Зависимость);
        КонецЕсли;
    КонецЦикла;
    
    Утверждения.ПроверитьРавенство(1, ФильтрованныеЗависимости.Количество(), "Без флага dev должна быть только 1 зависимость");
    Утверждения.ПроверитьРавенство("regular-dep", ФильтрованныеЗависимости[0].ИмяПакета, "Должна остаться только обычная зависимость");
    Утверждения.ПроверитьРавенство(Ложь, ФильтрованныеЗависимости[0].ДляРазработки, "Обычная зависимость должна иметь ДляРазработки = Ложь");
    
    // Тест 2: С флагом dev - должны устанавливаться обе зависимости
    УстанавливатьЗависимостиРазработчика = Истина;
    
    ФильтрованныеЗависимости.Очистить();
    
    Для Каждого Зависимость Из ВсеЗависимости Цикл
        Если Не Зависимость.ДляРазработки ИЛИ (УстанавливатьЗависимостиРазработчика И УровеньЗависимости = 0) Тогда
            ЗаполнитьЗначенияСвойств(ФильтрованныеЗависимости.Добавить(), Зависимость);
        КонецЕсли;
    КонецЦикла;
    
    Утверждения.ПроверитьРавенство(2, ФильтрованныеЗависимости.Количество(), "С флагом dev должны быть обе зависимости");
    
    // Проверяем, что обе зависимости присутствуют
    ИменаЗависимостей = Новый Массив;
    Для Каждого Зависимость Из ФильтрованныеЗависимости Цикл
        ИменаЗависимостей.Добавить(Зависимость.ИмяПакета);
    КонецЦикла;
    
    Утверждения.ПроверитьИстину(ИменаЗависимостей.Найти("regular-dep") <> Неопределено, "Должна присутствовать обычная зависимость");
    Утверждения.ПроверитьИстину(ИменаЗависимостей.Найти("dev-dep") <> Неопределено, "Должна присутствовать dev зависимость");
    
    // Тест 3: Dev зависимости не должны устанавливаться на вложенных уровнях
    УровеньЗависимости = 1; // Имитируем транзитивную зависимость
    
    ФильтрованныеЗависимости.Очистить();
    
    Для Каждого Зависимость Из ВсеЗависимости Цикл
        Если Не Зависимость.ДляРазработки ИЛИ (УстанавливатьЗависимостиРазработчика И УровеньЗависимости = 0) Тогда
            ЗаполнитьЗначенияСвойств(ФильтрованныеЗависимости.Добавить(), Зависимость);
        КонецЕсли;
    КонецЦикла;
    
    Утверждения.ПроверитьРавенство(1, ФильтрованныеЗависимости.Количество(), "На уровне 1 dev зависимости не должны устанавливаться");
    Утверждения.ПроверитьРавенство("regular-dep", ФильтрованныеЗависимости[0].ИмяПакета, "На уровне 1 должна остаться только обычная зависимость");
    
КонецПроцедуры

Функция ПолучитьСписокТестов(Знач Тестирование) Экспорт
    
    ЮТест = Тестирование;
    
    Тесты = Новый Массив;
    Тесты.Добавить("ТестДолжен_ФильтроватьЗависимостиПоФлагуРазработчика");
    
    Возврат Тесты;
    
КонецФункции

Процедура ПередЗапускомТеста() Экспорт
КонецПроцедуры

Процедура ПослеЗапускаТеста() Экспорт  
КонецПроцедуры